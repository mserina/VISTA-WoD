<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Listado de Usuarios</title>
  <link rel="stylesheet" th:href="@{/css/estilos.css}">
  <link rel="stylesheet" th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css}">
  <script th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js}"></script>
</head>
<body>

<!-- ///////////////////////////////////
            BARRA NAVEGACION                  
   //////////////////////////////////// -->
	<div class="container-fluid fondoBarraNavegacion">
		<div class="row align-items-center w-100">

			<!-- Logo -->
			<div class="col-auto">
				<a class="btn-icon" th:href="@{/}"> 
					<img class="logo" th:src="@{/images/logo.png}" alt="Logo">
				</a>
			</div>

			<!-- Opciones de navegación (centradas) -->
			<div class="col text-center d-none d-md-block">
				<nav class="nav justify-content-center">
					<h2><a class="nav-link text-white" th:href="@{/manga}">MANGA</a></h2>
					<h2><a class="nav-link text-white" th:href="@{/poster}">POSTER</a></h2> 
					<h2><a class="nav-link text-white" th:href="@{/figura}">FIGURA</a></h2>
				</nav>
			</div>
			
			<!-- Icono de usuario (activador del menú) -->
			<div class="col-auto ms-auto">
				<div class="dropdown">


					<!-- Para local -->
					<img
					  th:if="${perfilActivo == 'local'}"
					  class="rounded-circle dropdown-toggle-img"
					  sec:authorize="isAuthenticated()"
					  th:src="@{http://localhost:9511/usuario/foto/{id}(id=${usuario.id})}"
					  alt="Usuario"
					  width="40" height="40"
					  data-bs-toggle="dropdown"
					  aria-expanded="false" />
					
					<!-- Para producción -->
					<img
					  th:if="${perfilActivo != 'local'}"
					  class="rounded-circle dropdown-toggle-img"
					  sec:authorize="isAuthenticated()"
					  th:src="@{https://msm-sevilla.es/usuario/foto/{id}(id=${usuario.id})}"
					  alt="Usuario"
					  width="40" height="40"
					  data-bs-toggle="dropdown"
					  aria-expanded="false" />
			
					<!-- Imagen por defecto para usuarios no autenticados -->
					<img 
						class="rounded-circle dropdown-toggle-img"
						sec:authorize="isAnonymous()"
						th:src="@{/images/iconoUsuario.png}"
						alt="Usuario" width="40" height="40"
						data-bs-toggle="dropdown"
						aria-expanded="false">

					<!-- Menú desplegable -->
					<ul class="dropdown-menu dropdown-menu-end"
						aria-labelledby="dropdownMenuButton">
						<li th:if="${auth != null and auth.admin}"><a class="dropdown-item" th:href="@{/admin}">Lista de Usuarios</a></li>
						<li><a class="dropdown-item" th:href="@{/registro}">Registro</a></li>
						<li><a class="dropdown-item" th:href="@{/login}">Login</a></li>
						<li sec:authorize="hasRole('ADMIN')" ><a class="dropdown-item" th:href="@{/admin/obtenerUsuario}">Admin</a></li>
						<li sec:authorize="hasRole('ADMIN')" ><a class="dropdown-item" th:href="@{/admin/obtenerArticulos}">Articulos</a></li>
						<li><hr class="dropdown-divider"></li>
						<li><a class="dropdown-item text-danger" th:href="@{/logout}">Logout</a></li>
					</ul>
				</div>
			</div>

		</div>
	</div>




<!-- ///////////////////////////////////
            LISTA DE USUARIOS                  
   //////////////////////////////////// -->
  <div class="container mt-3">
     <input id="filtroNombre" type="text" class="form-control" placeholder="Buscar por nombre...">
  </div>
  <div class="container mt-5">
    <table class="table table-bordered">
      <thead id="cabezeraTablaUsuarios">
        <tr>
         
          <th>Nombre Completo</th>
          <th>Móvil</th>
          <th>Correo Electrónico</th>
          <th>Tipo Usuario</th>
          <th>Contraseña</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Mostrar usuarios -->
        <tr th:each="usuario : ${usuarios}">
          
          <td th:text="${usuario.nombreCompleto}"></td>
          <td th:text="${usuario.movil}"></td>
          <td th:text="${usuario.correoElectronico}"></td>
          <td th:text="${usuario.tipoUsuario}"></td>
		  <td th:text="${usuario.contrasena != null ? '********' : 'No asignada'}"></td>
          <td th:text="${usuario.verificado} ? 'Verificado' : 'No verificado'"></td>
          <td>
            <!-- Botón para abrir el formulario de edición con collapse de Bootstrap -->
            <button id="botonAcciones" class="btn btn-primary" type="button"
                    data-bs-toggle="modal"
                    th:data-bs-target="|#modalEditar-${usuario.id}|"
                    aria-expanded="false">
	              	<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-fill" viewBox="0 0 16 16">
					  <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.5.5 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11z"/>
					</svg>
            </button>
            <button id="botonAcciones" class="btn btn-danger" type="button"
		         th:attr="data-id=${usuario.id}, data-email=${usuario.correoElectronico}"
		        th:disabled="${auth != null and auth.getUsername() == usuario.correoElectronico}"
		        onclick="abrirModalBorrar(this.getAttribute('data-id'), this.getAttribute('data-email'))">
		        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
				  	<path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/>
				 </svg>
			</button>
          </td>
        </tr>        
      </tbody>
    </table>
    
    <a id="botonAcciones" th:href="@{/admin/usuarios/exportar(q=${q})}" class="btn btn-outline-primary mb-3">
  		<i class="bi bi-file-earmark-spreadsheet"><h6>Exportar CSV</h6></i> 
  	</a>
  
  </div>
  
  
 <!-- Modal para editar usuario con formulario completo -->
<div class="modal fade" th:each="usuario : ${usuarios}" th:id="|modalEditar-${usuario.id}|" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content contenedorFormularioModal">
      <form th:action="@{/admin/editarUsuario}" method="post" id="formEditarUsuario-[[${usuario.id}]]">
        <input type="hidden" name="id" th:value="${usuario.id}"/>
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarLabel">Editar Usuario</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <!-- Nombre Completo -->
          <div class="mb-3">
            <label for="nombreCompleto-[[${usuario.id}]]" class="form-label">Nombre Completo:</label>
            <input
              type="text"
              id="nombreCompleto-[[${usuario.id}]]"
              name="nombreCompleto"
              class="form-control"
              th:value="${usuario.nombreCompleto}"
              required
              maxlength="50" />
            <small class="error text-danger" id="nombreCompletoError-[[${usuario.id}]]"></small>
          </div>
          <!-- Móvil -->
          <div class="mb-3">
            <label for="movil-[[${usuario.id}]]" class="form-label">Móvil:</label>
            <input
              type="text"
              id="movil-[[${usuario.id}]]"
              name="movil"
              class="form-control"
              th:value="${usuario.movil}"
              placeholder="+34 600123456"
              required />
            <small class="error text-danger" id="movilError-[[${usuario.id}]]"></small>
          </div>
          <!-- Correo Electrónico -->
          <div class="mb-3">
            <label for="correoElectronico-[[${usuario.id}]]" class="form-label">Correo Electrónico:</label>
            <input
              type="email"
              id="correoElectronico-[[${usuario.id}]]"
              name="correoElectronico"
              class="form-control"
              th:value="${usuario.correoElectronico}"
              required />
            <small class="error text-danger" id="correoElectronicoError-[[${usuario.id}]]"></small>
          </div>
          <!-- Contraseña -->
          <div class="mb-3">
            <label for="contrasena-[[${usuario.id}]]" class="form-label">Contraseña:</label>
            <input
              type="password"
              id="contrasena-[[${usuario.id}]]"
              name="contrasena"
              class="form-control"
              placeholder="Dejar en blanco para no cambiar" />
            <small class="form-text text-muted">Mínimo 8 caracteres. Dejar vacío si no deseas modificarla.</small>
            <small class="error text-danger" id="contrasenaError-[[${usuario.id}]]"></small>
          </div>
        </div>
        
        <div class="mb-3">
		  <label for="tipoUsuario-[[${usuario.id}]]" class="form-label">Tipo de Usuario:</label>
		  <select
		    id="tipoUsuario-[[${usuario.id}]]"
		    name="tipoUsuario"
		    class="form-select"
		    required>
		    <option th:value="user" th:selected="${usuario.tipoUsuario == 'user'}">Usuario</option>
		    <option th:value="admin" th:selected="${usuario.tipoUsuario == 'admin'}">Administrador</option>
		  </select>
		</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

  
  
  <!-- Modal para confirmar borrado -->
   <div class="modal fade" id="modalBorrar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content contenedorFormularioModal">
        <div class="modal-header">
          <h5 id="campos" class="modal-title">Confirmar Borrado</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <form th:action="@{/admin/borrarUsuario}" method="post">
          <div class="modal-body">
            <p id="campos">Para confirmar, escribe el correo electrónico del usuario:</p>
            <p id="campos"><strong id="emailAConfirmar"></strong></p>
            <input type="hidden" id="campoIdModal" name="id">
            <input type="hidden" id="emailRealModal" name="emailInsertado">
            <div class="mb-3">
              <input type="email" id="emailConfirmacion" class="form-control" placeholder="usuario@ejemplo.com" required>
            </div>
          </div>
          <div class="modal-footer">
            <button id="botonAccionBorrar" type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
            <button id="btnBorrar" type="submit" class="btn btn-light" disabled>Borrar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  
   <!-- ///////////////////////////////////
                JAVASCRIPT                  
   //////////////////////////////////// -->
 <script>
  document.getElementById('filtroNombre').addEventListener('input', function() {
    const texto = this.value.toLowerCase();
    document.querySelectorAll('tbody tr').forEach(tr => {
      const nombre = (tr.children[0]?.textContent || '').toLowerCase();
      tr.style.display = nombre.includes(texto) ? '' : 'none';
    });
  });

  function abrirModalBorrar(id, email) {
    document.getElementById("campoIdModal").value = id;
    document.getElementById("emailRealModal").value = email;
    document.getElementById("emailAConfirmar").textContent = email;
    document.getElementById("emailConfirmacion").value = '';
    document.getElementById("btnBorrar").disabled = true;

    const inputBorrar = document.getElementById('emailConfirmacion');
    inputBorrar.removeEventListener('input', validarEmail);
    inputBorrar.addEventListener('input', validarEmail);

    function validarEmail() {
      document.getElementById('btnBorrar').disabled =
        inputBorrar.value.trim() !== document.getElementById('emailRealModal').value.trim();
    }

    new bootstrap.Modal(document.getElementById('modalBorrar')).show();
  }

  document.addEventListener('DOMContentLoaded', function() {
    const patternMovil = /^\+?\d{1,3}[- ]?\d{9}$/;

    // Validar formularios de editar usuarios
    document.querySelectorAll('[id^="formEditarUsuario-"]').forEach(form => {
      const id = form.id.split('-')[1];
      const nombre = document.getElementById('nombreCompleto-' + id);
      const movil = document.getElementById('movil-' + id);
      const correo = document.getElementById('correoElectronico-' + id);
      const contra = document.getElementById('contrasena-' + id);

      form.addEventListener('submit', function(e) {
        let valid = true;
        // Nombre
        if (!nombre.value || nombre.value.length > 50) {
          valid = false;
          document.getElementById('nombreCompletoError-' + id).textContent = 'Obligatorio, máx 50 caracteres.';
        } else {
          document.getElementById('nombreCompletoError-' + id).textContent = '';
        }
        // Móvil
        if (!patternMovil.test(movil.value)) {
          valid = false;
          document.getElementById('movilError-' + id).textContent = 'Formato incorrecto.';
        } else {
          document.getElementById('movilError-' + id).textContent = '';
        }
        // Correo
        if (!correo.validity.valid) {
          valid = false;
          document.getElementById('correoElectronicoError-' + id).textContent = 'Email inválido.';
        } else {
          document.getElementById('correoElectronicoError-' + id).textContent = '';
        }
        // Contraseña opcional
        if (contra.value && contra.value.length < 8) {
          valid = false;
          document.getElementById('contrasenaError-' + id).textContent = 'Mínimo 8 caracteres.';
        } else {
          document.getElementById('contrasenaError-' + id).textContent = '';
        }

        if (!valid) e.preventDefault();
      });
    });

    // Validar modal borrar (en caso de que no hubiera cargado ya)
    const input = document.getElementById('emailConfirmacion');
    if (input) {
      input.addEventListener('input', function() {
        document.getElementById('btnBorrar').disabled =
          this.value.trim() !== document.getElementById('emailRealModal').value.trim();
      });
    }
  });
</script>
 
</body>
</html>